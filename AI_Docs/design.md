# 小学校3年生向けタスク管理ゲーム 設計書

## 1. アプリケーション概要

### 1.1 目的と対象ユーザー

- **目的**: 小学校3年生の児童が実生活のタスクを項目化・時間見積もりし、効率的な実行順序を考えるスキルを育成するゲーム
- **対象ユーザー**: 小学校3年生の児童（特にiPadなどのタブレットを使用する子ども）
- **使用環境**:
  - メイン: iPad（標準サイズ）
  - その他の環境でも動作
  - ユーザー認証不要（1環境1ユーザー）
  - 進捗保存機能あり

## 2. UI/UX設計

### 2.1 基本レイアウト

- **画面上部**: レベル設定エリア（プルダウンメニュー）
- **画面左側**: タスク確認・作成エリア（サイドメニュー、ハンバーガーメニューで開閉可能）
- **画面中央**: タスクレイアウトエリア（メイン作業領域、時間軸に沿ったタスク配置）
- **画面下部**: タスクプールエリア（配置前のタスクが表示される場所）

### 2.2 レベル設定と各レベルでのゲーム要素

| レベル  | 特徴           | 使用可能タスク                   |
| ------- | -------------- | -------------------------------- |
| レベル1 | 基本の時間管理 | 所要時間のみのタスク             |
| レベル2 | 条件付きタスク | レベル1 + 条件付きタスク         |
| レベル3 | 待ち時間あり   | レベル2 + 待ち時間あるタスク     |
| レベル4 | 複雑な依存関係 | レベル3 + 依頼が必要なタスク     |
| レベル5 | 割り込み対応   | レベル4 + ランダム割り込みタスク |

### 2.3 コンポーネントデザイン

#### タスクカード

- 形状: 丸みを帯びた四角形
- サイズ:
  - タスクプール内: 横幅一律（8文字程度表示可能）
  - タスクレイアウト内: 時間軸に比例した横幅
- 色分け: ポップなユニバーサル色（各タスクごとに自動割り当て）
- レベル制限: 現在のレベルで使用できないタスクはグレーアウト表示
  - 例: レベル1選択時、条件が入力されているタスクは使用不可
  - 例: レベル2選択時、待ち時間が設定されているタスクは使用不可
- タスク情報表示:
  - タスク名（必須）
  - 所要時間（必須）
  - 条件（該当する場合）
  - 待ち時間（該当する場合）
  - 依頼内容（該当する場合）

#### 待ち時間のあるタスク表示

```
┌─────┐□□□□□□┌─────┐
│所要時間1 │ 待ち時間中 │所要時間2 │
└─────┘□□□□□□└─────┘
```

- 所要時間1: タスク開始から待ち時間開始までの時間
- 待ち時間中: 薄い色で表示、範囲設定された場合はその幅の部分は点線の輪郭
- 所要時間2: 待ち時間終了後のタスク（ドラッグで位置調整可能）

### 2.4 主要インタラクション

#### タスク作成・管理フロー

1. ハンバーガーメニューでタスク確認・作成画面の表示・非表示を切り替え
2. 上部の[+]ボタンをタップしてタスク作成メニューを表示
3. タスク名入力
4. 所要時間設定
5. 必要に応じて追加情報を設定:
   - 条件: プルダウンメニューで前提となるタスクを選択し、「どのタスクの後にしか実施できない」という条件を付ける（例: 「はみがき」は「朝ご飯」の後にしか実施できない）
   - 待ち時間: 数値入力（単位は分）と横にある範囲ボタンを押すと、入力した時間が消えてxx分～xx分のような絶対時間の範囲設定が可能（例: 10分の待ち時間に範囲ボタンを押すと「8分～30分」というような待ち時間範囲が設定できるようになる）
   - 待ち時間設定時: 自動的に[所要時間]が[所要時間1]に変わり、[所要時間2]入力項目が出現
   - 依頼内容: テキスト入力
6. 左下の[登録]ボタンでタスク保存、右下の削除ボタンで削除
7. 既存タスクをクリックで編集画面表示
8. ドラッグアンドドロップでタスクリスト内の順番を入れ替え
9. 各タスク左の[+]ボタンでタスクプールに追加（同じタスクを複数追加可能）

#### タスクプール操作フロー

1. サイドメニューからタスクをタスクプールに追加
2. タスクプール内のタスクを格子状に規則正しくレイアウト表示（ドラッグしやすいよう適切な空間を空けて配置）
3. タスクプール内でドラッグして順番の入れ替えが可能
4. 各タスクの右にある削除ボタンでプールからタスク削除
5. タスクをクリックするとタスクの全情報がポップアップ表示:
   - [閉じる]ボタン、余白、または別タスククリックでポップアップを閉じる
   - 数値をクリックすると編集可能
   - 設定されていない項目は空白表示、編集で追加可能
   - 編集した数値はサイドメニューのタスクとは独立して変化（コピーとして扱う）
6. タスクレイアウトにドラッグするとタスクが移動（タスクプールからは消える）
7. タスクプール右下の[ランダム]ボタンで、サイドメニューからランダムなタスクをランダムな数だけピックアップ

#### タスクレイアウト操作フロー

1. タスクプールからタスクレイアウトエリアにタスクをドラッグ
2. 初回配置時は自動的に開始位置（左上）に配置
3. ガントチャートのように上から順に1行ずつタスクが下に接続される
4. 次のタスクは前のタスクの後ろ（次の行の時系列線が一致するところ）に自動的に結合
5. タスク条件が一致する場合: 派手な結合エフェクトが表示（GSAPによる複雑なアニメーション）
6. タスク条件が不一致の場合: タスクプールに戻される（視覚的フィードバックあり）
7. 結合されたタスクをタップすると[解除]メニューが出現
   - 解除すると、そのタスクとその後ろに結合していたタスクも解除され、タスクプールに戻る
8. レベル5では、ランダムにタスク確認・作成画面からタスクが1つ強制的に追加・結合される
   - 例: タスクプールのタスクが10個あれば、何個目に配置したときに強制的に追加されるかがランダムで決まる
   - つまり10個配置終わるまでの間に必ず1回強制追加される（追加タイミングはユーザーのタスク配置時）

#### 待ち時間対応フロー

1. 待ち時間のあるタスクの所要時間1完了後、次のタスクに移行可能
2. タスク名の四角の後ろに待ち時間中の領域が薄い色で表示
3. 待ち時間に範囲設定がある場合、その範囲の部分は輪郭が点線表示
4. 待ち時間中に他のタスクを実行可能
5. 待ち時間終了後、その後ろに[所要時間2]の時間分タスクが表示（待ち時間に範囲設定がある場合は、最も遅い時間以降にしか配置できない）
6. [所要時間2]の開始時間は後ろに自由に移動可能
   - 例: 待ち時間中に長いタスクを行い、そのタスク終了後に続きを開始できる
7. [所要時間2]の部分をドラッグすると、その時点で最も後ろのタスクの終了部と結合され結合エフェクトが表示

## 3. データモデル設計

### 3.1 タスクオブジェクト

```typescript
interface Task {
  id: string; // タスクの一意識別子
  name: string; // タスク名
  duration1: number; // 所要時間1（分）
  waitTime?: {
    // 待ち時間（任意）
    duration: number; // 待ち時間（分）
    timeRange?: {
      // 待ち時間の範囲設定
      min: number; // 最小待ち時間（分）
      max: number; // 最大待ち時間（分）
    };
  };
  duration2?: number; // 所要時間2（分）- 待ち時間後
  condition?: string; // 条件となるタスクID（任意）
  request?: string; // 依頼内容（任意）
  color: string; // タスクカードの色
  isPreset: boolean; // プリセットタスクかどうか
}
```

### 3.2 アプリケーション状態

```typescript
interface AppState {
  level: 1 | 2 | 3 | 4 | 5; // 現在のレベル
  availableTasks: Task[]; // 使用可能なタスク一覧
  taskPool: Task[]; // タスクプール内のタスク
  layoutTasks: LayoutTask[]; // レイアウト配置済みタスク
  showSideMenu: boolean; // サイドメニュー表示状態
  showingInterruption: boolean; // 割り込みタスク表示中か
}

interface LayoutTask extends Task {
  startTime: number; // 開始時間（分）
  endTime: number; // 終了時間（分）
  waitEndTime?: number; // 待ち時間終了時間（分）
  phase2StartTime?: number; // 所要時間2の開始時間（分）
}
```

### 3.3 状態遷移例

#### タスク作成と配置

1. 初期状態

```
availableTasks: [タスクA, タスクB, タスクC]
taskPool: []
layoutTasks: []
```

2. タスクプールに追加

```
availableTasks: [タスクA, タスクB, タスクC]
taskPool: [タスクA, タスクB]
layoutTasks: []
```

3. タスクAをレイアウトに配置

```
availableTasks: [タスクA, タスクB, タスクC]
taskPool: [タスクB]
layoutTasks: [
  {
    ...タスクA,
    startTime: 0,
    endTime: タスクA.duration1
  }
]
```

4. タスクBをレイアウトに配置（条件が合致する場合）

```
availableTasks: [タスクA, タスクB, タスクC]
taskPool: []
layoutTasks: [
  {
    ...タスクA,
    startTime: 0,
    endTime: タスクA.duration1
  },
  {
    ...タスクB,
    startTime: タスクA.duration1,
    endTime: タスクA.duration1 + タスクB.duration1
  }
]
```

#### 待ち時間のあるタスクの配置

```
layoutTasks: [
  {
    ...タスクD,
    startTime: 0,
    endTime: タスクD.duration1,
    waitEndTime: タスクD.duration1 + タスクD.waitTime.duration,
    phase2StartTime: タスクD.duration1 + タスクD.waitTime.duration,
  },
  {
    ...タスクE,  // 待ち時間中に配置されたタスク
    startTime: タスクD.duration1,
    endTime: タスクD.duration1 + タスクE.duration1
  },
  {
    ...タスクD（所要時間2部分）,
    startTime: タスクE.endTime,  // 待ち時間後、タスクEの後に配置
    endTime: タスクE.endTime + タスクD.duration2
  }
]
```

## 4. 技術スタック

### 4.1 フロントエンド

- **ビルドツール**: Vite (React TypeScript+SWC)
- **UI・スタイリング**: React + Tailwind CSS + shadcn/ui（高品質なカスタマイズ可能なUIコンポーネントライブラリ）
- **状態管理**: Zustand（軽量な状態管理ライブラリ）
- **ドラッグ・アンド・ドロップ**:
  - dnd-kit: 高機能なドラッグ、ドロップ操作全般（タスク配置、並び替え、条件チェックなど）
- **アニメーション**:
  - Framer Motion: 基本的なトランジション効果・メニュー操作など
  - GSAP: 複雑なアニメーション（タスク結合エフェクト、時間軸ピンチ操作）
- **ストレージ**: localStorage（進捗保存用）

### 4.2 テスト・品質管理

- **リンター/フォーマッター**: ESLint + Prettier
- **E2Eテスト**: Playwright

### 4.3 デプロイ・ホスティング

- **ソース管理**: GitHub
- **ホスティング**: GitHub Pages

## 5. ディレクトリ構造

```
/
├── docs/                  # ビルド後のアプリ（GitHub Pages用）
├── public/                # 静的ファイル
│   ├── favicon.ico        # ファビコン
│   └── ...
├── AI_Docs/               # 設計ドキュメント
│   ├── design.md          # メイン設計書
│   ├── design_toc.md      # 設計書の目次(行数範囲)
│   ├── step.md            # ステップ別タスク管理
│   ├── step_toc.md        # ステップ別タスク管理の目次(行数範囲)
│   ├── TODO.md            # TODO管理(一時ファイル)
│   ├── notes.md           # ステップ実行時の実行手順
│   ├── log.md             # ステップ実行時の作業記録
│   ├── extract-toc.js     # tocファイル作成スクリプト(node extract-toc.js filename)
│   ├── init.md            # プロジェクト開始時の実行手順(step1の前まで)
│   └── ...
├── src/                   # ソースコード
│   ├── assets/            # 画像、フォントなど
│   ├── components/        # Reactコンポーネント
│   │   ├── ui/            # shadcn/uiコンポーネント
│   │   ├── common/        # 共通コンポーネント
│   │   ├── LevelSelector/ # レベル選択コンポーネント
│   │   ├── TaskCreator/   # タスク作成コンポーネント
│   │   ├── TaskLayout/    # タスクレイアウトコンポーネント
│   │   └── TaskPool/      # タスクプールコンポーネント
│   ├── hooks/             # カスタムフック
│   ├── lib/               # ユーティリティ関数やサードパーティライブラリ統合
│   │   ├── utils.ts       # 一般的なユーティリティ関数
│   │   └── dnd/           # dnd-kit関連の設定とヘルパー
│   ├── store/             # Zustandストア
│   ├── types/             # 型定義
│   ├── animations/        # アニメーション
│   │   ├── framer/        # Framer Motionアニメーション
│   │   └── gsap/          # GSAPアニメーション
│   ├── App.tsx            # アプリケーションコンポーネント
│   └── main.tsx           # エントリーポイント
├── tests/                 # テスト
│   ├── e2e/               # E2Eテスト (Playwright)
│   └── unit/              # ユニットテスト
├── .eslintrc.config.js    # ESLint設定
├── .prettierrc            # Prettier設定
├── components.json        # shadcn/ui設定
├── index.html             # HTMLテンプレート
├── package.json           # パッケージ設定
├── playwright.config.ts   # Playwright設定
├── postcss.config.js      # PostCSS設定
├── tailwind.config.js     # Tailwind CSS設定
├── tsconfig.json          # TypeScript設定
├── tsconfig.app.json      # TypeScript App設定
├── tsconfig.node.json     # TypeScript Node設定
├── vite.config.ts         # Vite設定
└── README.md              # プロジェクト説明
```

## 6. 機能詳細設計

### 6.1 タスク確認・作成画面詳細

- ハンバーガーメニューによる表示・非表示切り替え
- プリセットタスク例: 「顔を洗う」(1分)、「朝ご飯」(15分)、「はみがき」(3分、朝ご飯のあと)、「朝勉強」(10分、歯磨きのあと)
- タスクリスト表示:
  - 丸みを帯びた四角の中にタスク名が記載されたデザイン
  - ポップなユニバーサル色に自動設定
  - レベル制限に基づくグレーアウト表示
- カスタムタスク作成UI:
  - 5つの主要入力項目: タスク名・所要時間・条件・待ち時間・依頼
  - 条件: 既存タスクをプルダウンで選択
  - 待ち時間: 数値選択と範囲設定
  - [登録]・[削除]ボタン配置
- タスク管理コントロール:
  - クリックによる編集機能
  - ドラッグによる順序変更
  - [+]ボタンによるタスクプール追加

### 6.2 タスクプール詳細

- 格子状レイアウト: ドラッグしやすい適切な空間を確保
- 一貫したカードデザイン: 横幅一律（8文字程度表示可能、収まりきらない場合は[...]で省略表示）
- インタラクション:
  - ドラッグによる順序変更
  - 削除ボタンでタスク削除
  - クリックでタスク詳細ポップアップ
  - ポップアップ内での数値編集機能
- [ランダム]ボタン機能: ランダムなタスクをランダムな数だけピックアップ

### 6.3 タスクレイアウト詳細

- タイムドメイン表示:
  - 左から右への時間軸
  - 1分ごとの区切り線と経過時間表示
  - 横スクロール機能
  - ピンチ操作による拡大縮小機能
  - 拡大時にはタスク名が全て表示される（小さいサイズでは収まりきらないタスク名は[...]で省略表示）
- タスク配置ロジック:
  - ガントチャート形式の自動配置と結合（上から順に1行ずつ下に接続）
  - 条件チェックと視覚的フィードバック
  - 結合エフェクトアニメーション
  - この画面ではタスクの数値等は編集不可（必要ならタスクプールに戻してから編集する）
- 待ち時間表示:
  - 薄い色での待ち時間領域表示
  - 範囲指定部分の点線表示
  - 所要時間2の自由配置機能

### 6.4 レベル5割り込み機能詳細

- トリガー: タスク配置の進行中にランダムタイミングで発生
- 処理: ランダムなタスクが1つ強制的に追加・結合
- 視覚効果: 注目効果アニメーションで割り込みを強調
- ユーザー対応: 通常のタスクと同様に解除可能

### 6.5 機能要件の具体例

#### 6.5.1 タスク作成例

- **基本タスク**: 「顔を洗う」(所要時間: 1分)

  ```json
  {
    "id": "wash-face",
    "name": "顔を洗う",
    "duration1": 1,
    "color": "#FF9966",
    "isPreset": true
  }
  ```

- **条件付きタスク**: 「はみがき」(所要時間: 3分、朝ご飯のあと)

  ```json
  {
    "id": "brush-teeth",
    "name": "はみがき",
    "duration1": 3,
    "condition": "breakfast",
    "color": "#66CCFF",
    "isPreset": true
  }
  ```

- **待ち時間のあるタスク**: 「お菓子作り」(準備10分→焼く30分→仕上げ5分)
  ```json
  {
    "id": "make-sweets",
    "name": "お菓子作り",
    "duration1": 10,
    "waitTime": {
      "duration": 30,
      "variance": 5
    },
    "duration2": 5,
    "color": "#FF99CC",
    "isPreset": false
  }
  ```

#### 6.5.2 UI状態例

##### レベル1の状態

```json
{
  "level": 1,
  "availableTasks": [
    { "id": "wash-face", "name": "顔を洗う", "duration1": 1, "color": "#FF9966", "isPreset": true },
    { "id": "breakfast", "name": "朝ご飯", "duration1": 15, "color": "#99CC66", "isPreset": true }
  ],
  "taskPool": [],
  "layoutTasks": [],
  "showSideMenu": true,
  "showingInterruption": false
}
```

##### レベル3で待ち時間タスク実行中の状態

```json
{
  "level": 3,
  "taskPool": [
    {
      "id": "study",
      "name": "朝勉強",
      "duration1": 10,
      "condition": "brush-teeth",
      "color": "#CC99FF",
      "isPreset": true
    }
  ],
  "layoutTasks": [
    {
      "id": "wash-face",
      "name": "顔を洗う",
      "duration1": 1,
      "color": "#FF9966",
      "isPreset": true,
      "startTime": 0,
      "endTime": 1
    },
    {
      "id": "breakfast",
      "name": "朝ご飯",
      "duration1": 15,
      "color": "#99CC66",
      "isPreset": true,
      "startTime": 1,
      "endTime": 16
    },
    {
      "id": "brush-teeth",
      "name": "はみがき",
      "duration1": 3,
      "condition": "breakfast",
      "color": "#66CCFF",
      "isPreset": true,
      "startTime": 16,
      "endTime": 19
    },
    {
      "id": "make-sweets",
      "name": "お菓子作り",
      "duration1": 10,
      "waitTime": {
        "duration": 30,
        "variance": 5
      },
      "duration2": 5,
      "color": "#FF99CC",
      "isPreset": false,
      "startTime": 19,
      "endTime": 29,
      "waitEndTime": 59,
      "phase2StartTime": 64
    },
    {
      "id": "clean-room",
      "name": "部屋の掃除",
      "duration1": 20,
      "color": "#FFCC66",
      "isPreset": true,
      "startTime": 29,
      "endTime": 49
    },
    {
      // お菓子作りの所要時間2部分
      "id": "make-sweets-phase2",
      "name": "お菓子作り",
      "duration1": 5,
      "color": "#FF99CC",
      "isPreset": false,
      "startTime": 64,
      "endTime": 69
    }
  ],
  "showSideMenu": false,
  "showingInterruption": false
}
```

## 7. 保存機能設計

### 7.1 保存データ

- ローカルストレージ使用
- 保存内容:
  - 現在のレベル
  - 作成したカスタムタスク
  - タスクプールの状態
  - タスクレイアウトの状態

### 7.2 保存タイミング

- 自動保存機能:
  - タスクの追加・削除時
  - タスクの配置変更時
  - レベル変更時

### 7.3 データ復元

- アプリ起動時に自動的にローカルストレージから状態を復元
- データ形式はJSON
- エラー時の例外処理とフォールバック

## 8. 操作性とエラーハンドリング

### 8.1 マルチデバイス対応

- タッチ操作:
  - ドラッグ、タップ、ピンチ操作に対応
  - タッチ領域を十分に確保（最小44×44px）
- マウス操作:
  - クリック、ドラッグ&ドロップに対応
  - ホバー効果による操作ヒント

### 8.2 ユーザビリティ

- エラー防止:
  - 重要な操作（タスク削除など）は確認ダイアログを表示
  - 無効な操作の視覚的フィードバック
- ガイダンス:
  - 初回利用時のチュートリアル表示
  - ヘルプボタンからいつでも操作方法を確認可能

### 8.3 エラーハンドリング

- タスク配置エラー:
  - 条件不一致時の視覚的フィードバック
  - タスクが自動的にタスクプールに戻る際のアニメーション
- データエラー:
  - ローカルストレージ読み込み失敗時の処理
  - 不正なデータ形式への対応

## 9. アクセシビリティ対応

### 9.1 視覚的アクセシビリティ

- **色コントラスト**: WCAG AAレベル（4.5:1以上）のコントラスト比確保
- **フォントサイズ**: 最小16px以上、可読性の高いフォント
- **アイコン**: テキストラベル併用
- **フォーカス表示**: キーボード操作時の明確なフォーカス表示

### 9.2 操作性

- **タッチターゲット**: 最小44×44px以上のタッチ可能領域
- **エラー表示**: 視覚的かつテキストでのフィードバック
- **操作ガイド**: チュートリアルとヘルプ機能の提供

## 10. アニメーション設計

### 10.1 Framer Motionによるアニメーション

- タスクのドラッグ＆ドロップ（dnd-kitと連携し、ドラッグ時の見た目のアニメーション（スケーリング、スムーズな移動など）を担当）
- メニューの開閉トランジション
- タスクプールへのタスク追加/削除アニメーション
- エラー発生時のタスク揺れ効果
- ハンバーガーメニューのスライドイン/アウト
- タスクカードのホバーエフェクト

### 10.2 GSAPによる複雑なアニメーション

- タスク結合時のエフェクト（パーティクル効果、フラッシュ、モーフィングなど）
- 時間軸のピンチズーム効果
- 割り込みタスク出現時の注目効果
- 待ち時間タスクの特殊表示効果
- タスクの解除時の分解エフェクト
- レベル変更時のトランジション効果
